<html>
  <head>
  {% load static %}

  <link rel="stylesheet" type="text/css" href="{% static "csv2/common.css" %}">
  <link rel="stylesheet" type="text/css" href="{% static "csv2/vms.css" %}">

  <!-- <meta http-equiv="refresh" content="30"> -->
  </head>


  <body class="vms-nav">

    <!-- {% if err_message is not None %}
        <p style="color:red;">{{err_message}}</p>
    {% endif %}
    {% if message is not None %}
        <p style="color:green;">{{message}}</p>
    {% endif %} -->

    <!-- <div class="main-div"> -->
    <div class="vm-div">
      <form method="post">
        {% csrf_token %}


        {% if "foreign" not in request.path %}
          <div class="vm-buttons">
            <button class="button control-button" type="submit" formaction="/vm/update/" name="vm_option" value="manctl">Manual Control</button>
            <button class="button control-button" type="submit" formaction="/vm/update/" name="vm_option" value="sysctl">System Control</button>
            <button class="button retire-button" type="submit" formaction="/vm/update/" name="vm_option" value="retire">Retire VMs</button>
            <button class="button kill-button" type="submit" formaction="/vm/update/" name="vm_option" value="kill">Kill VMs</button>
          </div>
        {% else %}
        <!-- Grey-out the action buttons if looking at foreing VMs -->
          <div class="vm-buttons">
            <button class="button greyed-button" disabled>Manual Control</button>
            <button class="button greyed-button" disabled>System Control</button>
            <button class="button greyed-button" disabled>Retire VMs</button>
            <button class="button greyed-button" disabled>Kill VMs</button>
          </div>
        {% endif %}

        <div class=vm-table>
          <table id="vmsTable">
            <thead>
              <tr>
                <th style="width:25px"><input id="select-all" type="checkbox"/></th>
                <th onclick="sortTable(8)" style="width:150px">Cloud</th>
                <th onclick="sortTable(7)" style="width:100px">Project</th>
                <th onclick="sortTable(6)" style="width:450px">Hostname</th>
                <th onclick="sortTable(5)" style="width:100px">Status</th>
                <th onclick="sortTable(4)" style="width:200px">Status Changed Time</th>
                <th onclick="sortTable(3)" style="width:150px">Flavor Name</th>
                <th onclick="sortTable(2)" style="width:100px">Slots</th>
                <th onclick="sortTable(1)" style="width:150px">Slots Used</th>
                <th onclick="sortTable(0)" style="width:90px">Cores</th>
              </tr>
            </thead>
            <!-- In order to get the y-scroll on the left, the order of the columns is inverted. -->
            <tbody>
              {% for vm in vm_list %}
                <tr>
                  <td style="width:90px">{{vm.cores}}</td>
                  <td style="width:150px">{{vm.condor_slots_used}}</td>
                  <td style="width:100px">{{vm.condor_slots}}</td>
                  <td style="width:150px">{{vm.flavor_name}}</td>
                  <td style="width:200px">{{vm.status_changed_time}}</td>
                  <td style="width:100px">{{vm.poller_status}}</td>
                  <td style="width:450px">{{vm.hostname}}</td>
                  <td style="width:100px">{{vm.project}}</td>
                  <td style="width:150px">{{vm.cloud_name}}</td>
                  <td style="width:25px"><input type="checkbox" name="hostname.{{ forloop.counter }}" value={{vm.hostname}}></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </form>
    </div>
    <!-- Footer -->
    <div class="footer"
        {% if response_code == 1 %}
            <tr><td><b>Error: {{ message }}</b></td></tr>
        {% elif message is not None %}
            <tr><td>{{ message }}</td></tr>
        {% endif %}
    </div>

    <script type="text/javascript">
      // For the "select all checkbox"
      function checkToggle(event) {
        var changed = event.target,
          selectAll = document.getElementById('select-all'),
          checkboxes = Array.prototype.slice.call(
            this.querySelectorAll('input[type=checkbox]')
          ).filter(function(check) {
            return check !== selectAll;
          });

        if (changed === selectAll) {
          checkboxes.forEach(function(check) {
            check.checked = selectAll.checked;
          });
        } else {
          var allChecked = checkboxes.filter(function(check) {
            return check.checked;
          }).length === checkboxes.length;

          selectAll.checked = allChecked;
        }

      }

      var tableElement = document.querySelector('table');
      tableElement.addEventListener('change', checkToggle);

      // To sort by clicking the headers
      function sortTable(n) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("vmsTable");
        switching = true;
        // Set the sorting direction to ascending:
        dir = "asc";
        /* Make a loop that will continue until
        no switching has been done: */
        while (switching) {
          // Start by saying: no switching is done:
          switching = false;
          rows = table.getElementsByTagName("TR");
          /* Loop through all table rows (except the
          first, which contains table headers): */
          for (i = 1; i < (rows.length - 1); i++) {
            // Start by saying there should be no switching:
            shouldSwitch = false;
            /* Get the two elements you want to compare,
            one from current row and one from the next: */
            x = rows[i].getElementsByTagName("TD")[n];
            y = rows[i + 1].getElementsByTagName("TD")[n];
            /* Check if the two rows should switch place,
            based on the direction, asc or desc: */
            if (dir == "asc") {
              if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                // If so, mark as a switch and break the loop:
                shouldSwitch = true;
                break;
              }
            } else if (dir == "desc") {
              if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                // If so, mark as a switch and break the loop:
                shouldSwitch = true;
                break;
              }
            }
          }
          if (shouldSwitch) {
            /* If a switch has been marked, make the switch
            and mark that a switch has been done: */
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            // Each time a switch is done, increase this count by 1:
            switchcount ++;
          } else {
            /* If no switching has been done AND the direction is "asc",
            set the direction to "desc" and run the while loop again. */
            if (switchcount == 0 && dir == "asc") {
              dir = "desc";
              switching = true;
            }
          }
        }
      }
    </script>
  </body>
</html>
