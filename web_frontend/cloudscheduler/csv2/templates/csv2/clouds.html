
{% block navbar %}
   {% include "csv2/navigation_bar.html" %}
{% endblock %}

<head>
{% load template_utils %}
{% load static %}

<link rel="stylesheet" type="text/css" href="{% static "csv2/common.css" %}">
<link rel="stylesheet" type="text/css" href="{% static "csv2/clouds.css" %}">
<link rel="stylesheet" type="text/css" href="{% static "csv2/editor.css" %}">

<script type="text/javascript">

    var visited = {};

    function meta_fetch(cloudname , metaname) {

        var url='/cloud/metadata-fetch?{{active_group}}&cloud_name='+cloudname+'&metadata_name='+metaname
        var frame='editor-'+cloudname+'-'+metaname

        if (!visited[frame]){
            document.getElementById(frame).src=url;
            visited[frame]=1;
        }
    }

    function meta_add(cloudname) {

        var url='/cloud/metadata-new?{{active_group}}&cloud_name='+cloudname
        var frame='editor-'+cloudname+'-add'

        document.getElementById(frame).src=url;
    }


    function check_target(targetname) {

        var frame=targetname;

        document.getElementById(frame).checked = true;
    }

    function show_cloud(cloud_name){
        if (cloud_name.length > 0) {
            document.location.hash = cloud_name;
        }
    }

</script>

<script rel="preload" type="text/javascript" src="{% static "ace-builds/src-noconflict/ace.js" %}"></script>
<script rel="preload" type="text/javascript" src="{% static "csv2/editor.js" %}"></script>

</head>
<body class="clouds-nav" onpageshow="show_cloud('{{current_cloud}}') ; check_target('{{cloud_list.0.cloud_name}}-settings')">

<div class="main-div">
    <div class="menu">
    {% for cloud in cloud_list %}
        <div id="{{cloud.cloud_name}}"> <a href="#{{cloud.cloud_name}}" class="menu-link" onclick="check_target('{{cloud.cloud_name}}-settings') ; check_target('{{cloud.cloud_name}}-hide')">{{cloud.cloud_name}}</a>
            
            <div class="menu-target">

                <div class="tab">
                    <input id="{{cloud.cloud_name}}-settings" type="radio" name="tabs" onclick="check_target('{{cloud.cloud_name}}-hide')" checked>
                    <label class="highlight3" for="{{cloud.cloud_name}}-settings">Settings</label>
                    <div class="tab-content">

                        <form name="{{cloud.cloud_name}}" action="/cloud/update/#{{cloud.cloud_name}}" method="post" onchange="msg_tbl.style='display:none;'" autocomplete="nope">
                            {% csrf_token %}
                            <table><tr><td>

                                <table>
                                    <input type="hidden" name="group" value="{{ cloud.group_name }}">
                                    <input type="hidden" name="cloud_name" value="{{cloud.cloud_name}}" />


                                    <input type="hidden" name="enabled" value="0" />

                                    <tr class="highlight3"><td><label for="authurl">Enabled</label></td>
                                    <td>
                                    {% if cloud.enabled == 1%}
                                        <input type="checkbox" name="enabled" value="1" checked/>
                                    {% else %}
                                        <input type="checkbox" name="enabled" value="1" />
                                    {% endif %}
                                    </td></tr>

                                    <tr class="highlight3"><td><label for="authurl">URL</label></td>
                                    <td><input type="text" name="authurl" value="{{cloud.authurl}}" /></td></tr>
                                    <tr class="highlight3"><td><label for="project">Project</label></td>
                                    <td><input type="text" name="project" value="{{cloud.project}}" /></td></tr>
                                    <tr class="highlight3"><td><label for="username">Username</label></td>
                                    <td><input type="text" name="username"  value="{{cloud.username}}" /></td></tr>
                                    <tr class="highlight3"><td><label for="password">Password</label></td>
                                    <td><input type="password" name="password" placeholder="Update password" value="" autocomplete="new-password"/></td></tr>

                                    <tr class="highlight3"><td><label for="cacertificate">CA certificate</label></td>
                                    <td><input type="text" name="cacertificate" value="{{cloud.cacertificate}}" /></td></tr>
                                    <tr class="highlight3"><td><label for="region">Region</label></td>
                                    <td><input type="text" name="region" value="{{cloud.region}}" /></td></tr>
                                    <tr class="highlight3"><td><label for="user_domain_name">User domain name</label></td>
                                    <td><input type="text" name="user_domain_name" value="{{cloud.user_domain_name}}" /></td></tr>
                                    <tr class="highlight3"><td><label for="project_domain_name">Project domain name</label></td>
                                    <td><input type="text" name="project_domain_name" value="{{cloud.project_domain_name}}" /></td></tr>


                                    <tr class="highlight3"><td><label for="spot_price">Spot Price</label></td>
                                    <td><input type="text" name="spot_price" value="{{cloud.spot_price}}" /></td></tr>
                                </table>

                            <td>    

                                <table>
                                    <tr class="highlight3"><td><label for="cloud_type">Cloud type</label></td>
                                    <td><select name="cloud_type" class="dropdown"/>
                                    {% for type in type_list %}
                                        {% if cloud.cloud_type == type.cloud_type %}
                                            <option value="{{ type.cloud_type }}" selected>{{ type.cloud_type }}</option>
                                        {% else %}
                                            <option value="{{ type.cloud_type }}">{{ type.cloud_type }}</option>
                                        {% endif %}
                                    {% endfor %}
                                    </td></tr>
                                


                                    <tr class="highlight3"><td><label for="vm_keyname">VM Keyname</label></td>
                                    <td><select name="vm_keyname" class="dropdown"/>
                                    <option value=""></option>
                                    {% for key in keypairs_list %}
                                        {% if key.cloud_name == cloud.cloud_name%}
                                            {% if key.key_name == cloud.vm_keyname %}
                                                <option value="{{ key.key_name }}" selected>{{ key.key_name }}</option>
                                            {% else %}
                                                <option value="{{ key.key_name }}">{{ key.key_name }}</option>
                                            {% endif %}
                                        {% endif %}   
                                    {% endfor %}

                                    <tr class="highlight3"><td><label for="vm_network">VM Network</label></td>
                                    <td><select name="vm_network" class="dropdown"/>
                                    <option value=""></option>
                                    {% for network in network_list %}
                                        {% if network.cloud_name == cloud.cloud_name%}
                                            {% if network.name == cloud.vm_network %}
                                                <option value="{{ network.name }}" selected>{{ network.name }}</option>
                                            {% else %}
                                                <option value="{{ network.name }}">{{ network.name }}</option>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    </td></tr>


                                    <tr class="highlight3"><td><label for="vm_image">VM Image</label></td>
                                    <td><select name="vm_image" class="dropdown"/>
                                    <option value=""></option>
                                    {% for image in image_list %}
                                        {% if image.cloud_name == cloud.cloud_name%}
                                            {% if image.name == cloud.vm_image %}
                                                <option value="{{ image.name }}" selected>{{ image.name }}</option>
                                            {% else %}
                                                <option value="{{ image.name }}">{{ image.name }}</option>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    </td></tr>

                                    <tr class="highlight3"><td><label for="vm_flavor">VM Flavor</label></td>
                                    <td><select name="vm_flavor" class="dropdown"/>
                                    <option value=""></option>
                                    {% for flavor in flavor_list %}
                                        {% if flavor.cloud_name == cloud.cloud_name%}
                                            {% if flavor.name == cloud.vm_flavor %}
                                                <option value="{{ flavor.name }}" selected>{{ flavor.name }}</option>
                                            {% else %}
                                                <option value="{{ flavor.name }}">{{ flavor.name }}</option>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    </td></tr>

                                    <tr class="highlight3"><td><label for="vm_keep_alive">VM Keep Alive</label></td>
                                    <td><input type="text" name="vm_keep_alive" value="{{cloud.vm_keep_alive}}" /></td></tr>


                                </table>

                                <br>

                                <table>
                                    <tr class="highlight2"><td><label for="cores_softmax">Cores Softmax</label></td>
                                    <td><input type="text" name="cores_softmax" value="{{cloud.cores_softmax}}" /></td></tr>

                                    <tr class="highlight2"><td><label for="cores_ctl">Cores</label></td>
                                    <td>
                                        
                                        <input id="slider-cores" type="range" min="-1" max="{{cloud.cores_max}}" value="{{cloud.cores_ctl}}" name="cores_slider" oninput="cores_ctl.value=cores_slider.value" />
                                        <input id="ctl-cores" type="number" min="-1" max="{{cloud.cores_max}}" value="{{cloud.cores_ctl}}" name="cores_ctl" oninput="cores_slider.value=cores_ctl.value" />
                                        / {{cloud.cores_max}}
                                    </td></tr>
                                    <!--<td>
                                        {% if cloud.cores_ctl == -1 %}
                                        Using Quota
                                        {% endif %}
                                    </td></tr>-->

                                    <tr class="highlight2"><td><label for="ram_ctl">RAM</label></td>
                                    <td>
                                        <input id="slider-ram" type="range" min="-1" max="{{cloud.ram_max}}" value="{{cloud.ram_ctl}}" name="ram_slider" oninput="ram_ctl.value=ram_slider.value" />
                                        <input id="ctl-ram" type="number" min="-1" max="{{cloud.ram_max}}" value="{{cloud.ram_ctl}}" name="ram_ctl" oninput="ram_slider.value=ram_ctl.value" />
                                        / {{cloud.ram_max}} KB
                                    </td></tr>
                                    <!--<td>
                                        {% if cloud.ram_ctl == -1 %}
                                        Using Quota
                                        {% endif %}
                                    </td></tr>-->

                                </table>
                            </td></tr>

                            <tr>
                                <td class="left"><input type="submit" value="Update Cloud" /></td>
                                <td></td>
                            </tr>

                        </table>
                        </form>

                        <div class="bottom-right">
                            <a href="#delete-{{cloud.cloud_name}}"><button type="button">Delete</button></a>
                        </div>

                        <div class="tab2">
                            <input id="{{cloud.cloud_name}}-hide" type="radio" name="tabs2">
                            <div class="tab2-hide"></div>
                        </div>

                    </div>

                </div>



                <div class="tab">
                    <input id="metadata-{{cloud.cloud_name}}" type="radio" name="tabs">
                    <label class="highlight4" for="metadata-{{cloud.cloud_name}}">Metadata</label>
                    <div class="tab-content meta-div">


                        {% for key, value in metadata_dict.items %}


                            {% for meta in value|keyvalue:cloud.cloud_name %}

                                <div class="tab2">
                                    <input id="metadata-{{cloud.cloud_name}}-{{meta}}" type="radio" name="tabs2" onclick="meta_fetch('{{cloud.cloud_name}}', '{{meta}}')">
                                    <label class="highlight4" for="metadata-{{cloud.cloud_name}}-{{meta}}">{{meta}}</label>
                                    <div class="tab2-content">

                                        <iframe id="editor-{{cloud.cloud_name}}-{{meta}}"  src=""></iframe>

                                    </div>

                                </div>


                            {% endfor %}
                        {% endfor %}


                        <div class="tab2">
                            <input id="metadata-{{cloud.cloud_name}}-add" type="radio" name="tabs2" onclick="meta_add('{{cloud.cloud_name}}')">
                            <label class="highlight4" for="metadata-{{cloud.cloud_name}}-add">+</label>
                            <div class="tab2-content">

                                <iframe id="editor-{{cloud.cloud_name}}-add"  src=""></iframe>

                            </div>

                        </div>

                    </div>


                </div>



                <div class="tab">
                    <input id="exclusions-{{cloud.cloud_name}}" type="radio" name="tabs">
                    <label class="highlight5" for="exclusions-{{cloud.cloud_name}}">Exclusions</label>
                    <div class="tab-content exclusion-div">


                        <div class="tab2">
                            <input id="exclusions-{{cloud.cloud_name}}-metadata" type="radio" name="tabs2">
                            <label class="highlight4" for="exclusions-{{cloud.cloud_name}}-metadata">Default metadata</label>

                            <div class="tab2-content">
                                <form name="{{cloud.cloud_name}}-metadata-exclusions" action="/cloud/update/#{{cloud.cloud_name}}" method="post">
                                {% csrf_token %}
                                    <table>
                                        <input type="hidden" name="group" value="{{ cloud.group_name }}">
                                        <input type="hidden" name="cloud_name" value="{{cloud.cloud_name}}" />
                                        <input type="hidden" name="password" value=""/>

                                    {% for meta in group_metadata_dict %}
                                        <tr><td class="highlight2"><input type="checkbox" name="metadata_name.{{ forloop.counter }}" value="{{ meta.metadata_name }}" 
                                            {% for exclusion in group_metadata_exclusion_list%}
                                                {% if exclusion.cloud_name == cloud.cloud_name and exclusion.metadata_name == meta.metadata_name %}
                                                    checked
                                                {% endif %}
                                            {% endfor %}
                                        />{{ meta.metadata_name }}</input></td></tr>
                                    {% endfor %}

                                        <tr>
                                            <td>
                                                <input type="submit" value="Update Metadata Exclusions" />
                                            </td>

                                        </tr>

                                    </table>
                                </form>
                            </div>
                        </div>

                        <br>

                        <div class="tab2">

                            <input id="exclusions-{{cloud.cloud_name}}-flavors" type="radio" name="tabs2">
                            <label class="highlight4" for="exclusions-{{cloud.cloud_name}}-flavors">Default flavors</label>

                            <div class="tab2-content">
                                <form name="{{cloud.cloud_name}}-flavor-exclusions" action="/cloud/update/#{{cloud.cloud_name}}" method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="group" value="{{ cloud.group_name }}">
                                    <input type="hidden" name="cloud_name" value="{{cloud.cloud_name}}" />
                                    <input type="hidden" name="password" value=""/>
                                    <table>

                                    {% for flavor in flavor_list %}
                                        {% if flavor.cloud_name == cloud.cloud_name %}
                                            <tr><td class="highlight2"><input type="checkbox" name="flavor_name.{{ forloop.counter }}" value="{{ flavor.name }}"
                                                {% for exclusion in flavor_exclusion_list%}
                                                    {% if exclusion.cloud_name == cloud.cloud_name and exclusion.flavor_name == flavor.name %}
                                                        checked
                                                    {% endif %}
                                                {% endfor %}
                                            />{{ flavor.name }}</input></td></tr>
                                        {% endif %}
                                    {% endfor %}

                                        <tr>
                                            <td>
                                                <input type="submit" value="Update Flavor Exclusions" />
                                            </td>

                                        </tr>

                                    </table>
                                </form>
                            </div>

                        </div>

                    </div>


                </div>

            </div>

        </div>
    {% endfor %}
        <div id="add-cloud"> <a href="#add-cloud" class="menu-link">+</a>
            <div class="menu-target">
                <form name="add_cloud" action="/cloud/add/" method="post">
                    {% csrf_token %}
                    <div class="menu-position">
                        <table>
                            <input type="hidden" name="group" value="{{active_group}}">

                            <tr class="highlight3"><td><label for="cloud_name">Cloud name</label></td>
                            <td><input type="text" name="cloud_name" value="" /></td></tr>


                            <input type="hidden" name="enabled" value="0" />
                            <tr class="highlight3"><td><label for="authurl">Enabled</label></td>
                            <td><input type="checkbox" name="enabled" value="1" /></td></tr>

                            <tr class="highlight3"><td><label for="authurl">URL</label></td>
                            <td><input type="text" name="authurl" value="" /></td></tr>
                            <tr class="highlight3"><td><label for="project">Project</label></td>
                            <td><input type="text" name="project" value="{{cloud.project}}" /></td></tr>
                            <tr class="highlight3"><td><label for="username">Username</label></td>
                            <td><input type="text" name="username" value="" /></td></tr>
                            <tr class="highlight3"><td><label for="password">Password</label></td>
                            <td><input type="password" name="password" value="" /></td></tr>

                            <tr class="highlight3"><td><label for="vm_keyname">VM Keyname</label></td>
                            <td><select name="vm_keyname" class="dropdown"/>
                            <option value=""></option>
                            {% for key in keypairs_list %}
                                <option value="{{ key.key_name }}">{{ key.key_name }}</option>
                            {% endfor %}

                            <tr class="highlight3"><td><label for="cacertificate">CA certificate</label></td>
                            <td><input type="text" name="cacertificate" value="{{cloud.cacertificate}}" /></td></tr>
                            <tr class="highlight3"><td><label for="region">Region</label></td>
                            <td><input type="text" name="region" value="{{cloud.region}}" /></td></tr>
                            <tr class="highlight3"><td><label for="user_domain_name">User domain name</label></td>
                            <td><input type="text" name="user_domain_name" value="{{cloud.user_domain_name}}" /></td></tr>
                            <tr class="highlight3"><td><label for="project_domain_name">Project domain name</label></td>
                            <td><input type="text" name="project_domain_name" value="{{cloud.project_domain_name}}" /></td></tr>


                            <tr class="highlight3"><td><label for="cloud_type">Cloud type</label></td>
                            <td><select name="cloud_type" class="dropdown"/>
                            {% for type in type_list %}
                                <option value="{{ type.cloud_type }}">{{ type.cloud_type }}</option>
                            {% endfor %}

                            <tr><td><input type="submit" value="Add Cloud" /></td></tr>
                        </table>
                    </div>
                </form>  
            </div>
        </div>
    </div>

    {% for cloud in cloud_list %}
    <div id="delete-{{cloud.cloud_name}}" class="modalDialog">
        <div>
            <a href="#{{cloud.cloud_name}}" title="Close" class="close">X</a>
            <form name="{{cloud.cloud_name}}" action="/cloud/delete/" method="post">
                {% csrf_token %}
                <input type="hidden" name="group" value="{{cloud.group_name}}" />
                <input type="hidden" name="cloud_name" value="{{cloud.cloud_name}}" />
                <input type="submit" value="Delete {{cloud.cloud_name}}" />
            </form>
        </div>
    </div>
    {% endfor %}


</div>

<div class="footer"
    {% if response_code == 1 %}
        <tr><td><b>Error: {{ message }}</b></td></tr>
    {% elif message is not None %}
        <tr><td>{{ message }}</td></tr>
    {% endif %}
</div>

<script rel="preload" type="text/javascript" src="{% static "csv2/editor.js" %}"></script>

<script>
    /*
    {% for cloud in cloud_list %}
        createEditor("{{cloud.cloud_name}}editor")
    {% endfor %}
    */
</script>

</body>
