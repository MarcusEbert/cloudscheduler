<head>
<meta http-equiv="refresh" content="60">
{% load static %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<link rel="stylesheet" type="text/css" href="{% static "csv2/common.css" %}">
<link rel="stylesheet" type="text/css" href="{% static "csv2/clouds.css" %}">
<link rel="stylesheet" href="/static/glintwebui/css/glint_button.css">
<link rel="stylesheet" href="/static/glintwebui/css/glint_header_footer.css">
<link rel="stylesheet" href="/static/glintwebui/css/glint_matrix.css">
<link rel="stylesheet" href="/static/glintwebui/css/glint_dropdown_button.css">

<style>

{% load glint_template_utils %}

.header_table{
    border: 0;
}

.popover{
    position: absolute;
}

.popover-content{
    border: 2px solid black; 
    border-radius: 5px;
    background-color: white;
}

.popover-title{
    background-color: white;
    padding: none
}

</style>
</head>
{% block navbar %}
    {% include "csv2/navigation_bar.html" %}
{% endblock %}
<div class="wrapper" style="padding-top:60px;padding-bottom:5px">
    <div id="page_header">
                 <h1 style="float:left; margin:0px">User Keys</h1>
                 <input type="text" id="image_search" autofocus="autofocus" placeholder="Search by Key Name">
                 <a style="border: 2px solid black; border-radius: 5px; background-color:white;" class="button" href="#" id="popover-uploadkey" data-placement="bottom">+Upload Key</a>
                 <a style="border: 2px solid black; border-radius: 5px; background-color:white;" class="button" href="#" id="popover-newkey" data-placement="bottom">Create Key</a>
                 <input stlye="float:left" class="button greenbutton" style="height:44px;" type="submit" onclick="submitKeyMatrix()" value="Submit Changes" />
    </div>
    <div id="popover-uploadkey-content" class="hide" hidden style="position:absolute">
        <h2>Upload Key</h2>
        <form name="upload_key" action="/images/add_key/" method="post">
            {% csrf_token %}
            <table>
                <tr><td><label for="key_name">Key Name</label></td>
                <td><input type="text" name="key_name" id="" value="" /></td></tr>
                <tr><td><label for="key_string">Public Key</label></td>
                <td><input type="text" name="key_string" id="" value="" /></td></tr>
                <tr hidden><td><label for="group_name">Group Name</label></td>
                <td><input type="text" name="group_name" id="" value="{{active_group}}" /></td></tr>
                <tr style="border: 0"><td style="border: 0"/><td style="border: 0" ><input type="submit" value="Submit" /></td></tr>
            </table>
        </form>
    </div>
    <div id="popover-newkey-content" class="hide" hidden style="position:absolute">
        <h2>Create Key</h2>
        <form name="new_key" action="/images/create_key/" method="post">
            {% csrf_token %}
            <table>
                <tr><td><label for="key_name">Key Name</label></td>
                <td><input type="text" name="key_name" id="" value="" /></td></tr>
                <tr hidden><td><label for="group_name">Group Name</label></td>
                <td><input type="text" name="group_name" id="" value="{{active_group}}" /></td></tr>
                <tr style="border: 0"><td style="border: 0"/><td style="border: 0" ><input type="submit" value="Submit" /></td></tr>
            </table>
        </form>
    </div>
</div>
<div class="image_matrix" style="float:left">
    <form id="keypair_form" name="keypair_form" action="/images/save_keypairs/{{active_group}}/" method="post">
    {% csrf_token %}
    <table>
        <tr>
            <th>Keys\Clouds</th>
            {% for cloud in group_resources %}
                <th>{{cloud.cloud_name}}</th>
            {% endfor %}
        </tr>
        {% for key in fingerprint_dict %}
            <tr class="key_row">
                <th>
                    {{fingerprint_dict|get_item:key|get_item:"name"}}
                </th>
                {% for cloud in group_resources %}
                    {% if fingerprint_dict|get_item:key|get_item:cloud.cloud_name %}
                        <td class="{{key}}"><input name="{{cloud.cloud_name}}" type="checkbox" value="{{key}}" checked></td>
                    {% else %}
                        <td class="{{key}}"><input name="{{cloud.cloud_name}}" type="checkbox" value="{{key}}" ></td>
                    {% endif %}
                {% endfor %}
            </tr>
        {% endfor %}
    </table>
</form></div>

<script>
function submitKeyMatrix(){
    document.getElementById("keypair_form").submit();
}

var $rows = $('.key_row');
var val = $.trim($('#image_search').val()).replace(/ +/g, ' ').toLowerCase();
$rows.filter(function() {
    var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
    return !~text.indexOf(val);
}).hide();

$('#image_search').keyup(function() {
    var filter = localStorage.getItem("filter");
    var $rows = $('.key_row');
    var val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
    $rows.show().filter(function() {
        var text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
        return !~text.indexOf(val);
    }).hide();
});


$('#popover-uploadkey').popover({ 
    html : true,
    title: function() {
      return $("#popover-uploadkey-head").html();
    },
    content: function() {
      return $("#popover-uploadkey-content").html();
    }
});

$('#popover-newkey').popover({ 
    html : true,
    title: function() {
      return $("#popover-newkey-head").html();
    },
    content: function() {
      return $("#popover-newkey-content").html();
    }
});
</script>
