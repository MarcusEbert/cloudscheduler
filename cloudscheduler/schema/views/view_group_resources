/*
** List all group resources (clouds) and for each resource (cpu, disk, ephemeral disk(scrtch), ram, and swap) show 
** contol, max, used, foreign, and native values.
*/
create or replace view view_group_resources as

select

vgrr.*,

case when cores_ctl=-1 then
    cores_max-(cores_native+cores_foreign)
else
    least(cores_ctl-cores_native, cores_max-(cores_native+cores_foreign))
end as cores_idle,


case when ram_ctl=-1 then
    ram_max-(ram_native+ram_foreign)
else
    least(ram_ctl-ram_native, ram_max-(ram_native+ram_foreign))
end as ram_idle

from (
    select

    cgr.group_name,
    cgr.cloud_name,
    cgr.enabled,
    cgr.spot_price,
    cgr.vm_flavor,
    cgr.vm_image,
    cgr.vm_keep_alive,

    case when cgr.vm_flavor is null or cgr.vm_flavor='' then
        case when cgd.vm_flavor is null or cgr.vm_flavor='' then
            null
        else
            cgd.vm_flavor
        end
    else
        cgr.vm_flavor
    end as cascading_vm_flavor,

    case when cgr.vm_image is null or cgr.vm_image='' then
        case when cgd.vm_image is null or cgr.vm_image='' then
            null
        else
            cgd.vm_image
        end
    else
        cgr.vm_image
    end as cascading_vm_image,

    case when cgr.vm_keep_alive is null or cgr.vm_keep_alive=-1 then
        case when cgd.vm_keep_alive is null or cgd.vm_keep_alive=-1 then
            0
        else
            cgd.vm_keep_alive
        end
    else
        cgr.vm_keep_alive
    end as cascading_vm_keep_alive,

    authurl,
    project_domain_name,
    cgr.project,
    user_domain_name,
    username,
    password,
    keyname,
    cacertificate,
    region,
    cloud_type,

    case when cores_ctl=-1 then
        cores_ctl
    else
        case when ifnull(cores_ctl,0)>ifnull(cores_max,0) then
            ifnull(cores_max,0)
        else
            ifnull(cores_ctl,0)
        end
    end as cores_ctl,
    ifnull(cores_max, 0) as cores_max,
    ifnull(cores_used, 0) as cores_used,
    sum(case when vv.cores is NULL or vv.foreign_vm=0 then 0 else vv.cores end) as cores_foreign,
    sum(case when vv.cores is NULL or vv.foreign_vm=1 then 0 else vv.cores end) as cores_native,

    case when ram_ctl=-1 then
        ram_ctl
    else
        case when ifnull(ram_ctl,0)>ifnull(ram_max,0) then
            ifnull(ram_max,0)
        else
            ifnull(ram_ctl,0)
        end
    end as ram_ctl,
    ifnull(ram_max, 0) as ram_max,
    ifnull(ram_used, 0) as ram_used,
    sum(case when vv.ram is NULL or vv.foreign_vm=0 then 0 else vv.ram end) as ram_foreign,
    sum(case when vv.ram is NULL or vv.foreign_vm=1 then 0 else vv.ram end) as ram_native,

    ifnull(instances_max, 0) as instances_max,
    ifnull(instances_used, 0) as instances_used,

    ifnull(floating_ips_max, 0) as floating_ips_max,
    ifnull(floating_ips_used, 0) as floating_ips_used,

    ifnull(security_groups_max, 0) as security_groups_max,
    ifnull(security_groups_used, 0) as security_groups_used,

    ifnull(server_groups_max, 0) as server_groups_max,
    ifnull(server_groups_used, 0) as server_groups_used,

    ifnull(image_meta_max, 0) as image_meta_max,
    ifnull(keypairs_max, 0) as keypairs_max,
    ifnull(personality_max, 0) as personality_max,
    ifnull(personality_size_max, 0) as personality_size_max,
    ifnull(security_group_rules_max, 0) as security_group_rules_max,
    ifnull(server_group_members_max, 0) as server_group_members_max,
    ifnull(server_meta_max, 0) as server_meta_max

    from csv2_group_resources as cgr
    left outer join csv2_group_defaults as cgd on cgr.group_name=cgd.group_name
    left outer join cloud_limits as cl on cgr.group_name=cl.group_name and cgr.cloud_name=cl.cloud_name
    left outer join view_vms as vv on cgr.group_name=vv.group_name and cgr.cloud_name=vv.cloud_name


    group by cgr.group_name,cgr.cloud_name
    ) as vgrr /* view_group_resources_raw */

order by group_name,cloud_name
;
