/*
** List all condor jobs (one row per job) and for each requested resouce (cpu,
** ram, disk, and swap) which is either Null or zero, set the group default
** value for that resource.
*/
create or replace view view_condor_jobs_group_defaults_applied as

select
  global_job_id,
  cj.group_name,
  target_clouds,
  job_status,
  case when request_cpus is NULL or request_cpus<0 then case when job_cpus is NULL then 0 else job_cpus end else request_cpus end as request_cpus,
  case when request_disk is NULL or request_disk<0 then case when job_disk is NULL then 0 else job_disk end else request_disk / (1024 * 1024) end as request_disk,
  case when request_ram is NULL or request_ram<0 then case when job_ram is NULL then 0 else job_ram end else request_ram end as request_ram,
  case when request_swap is NULL or request_swap<0 then case when job_swap is NULL then 0 else job_swap end else request_swap / (1024*1024) end as request_swap,
  requirements,
  job_priority,
  cluster_id,
  proc_id,
  user,
  image,
  instance_type,
  network,
  keep_alive,
  max_price,
  user_data,
  job_per_core,
  entered_current_status,
  q_date,
  hold_job_reason,
  held_reason,
  case when job_status=1 then 1 else 0 end as js_idle, 
  case when job_status=2 then 1 else 0 end as js_running, 
  case when job_status=4 then 1 else 0 end as js_completed, 
  case when job_status=5 then 1 else 0 end as js_held, 
  case when job_status=0 or job_status=3 or job_status=6 then 1 else 0 end as js_other 

from condor_jobs as cj

left outer join csv2_group_defaults as cgd on
  cj.group_name=cgd.group_name

;
