/*
** Retrieve groups/cloud summary information.
*/
create or replace view view_cloud_status as

/*
** Retrieve all groups.
*/
select

vcsr.group_name,
vcsr.cloud_name,
cast(sum(VMs) as int) as VMs,
sum(VMs_running) as VMs_running,
sum(VMs_retiring) as VMs_retiring,
sum(VMs_in_error) as VMs_in_error,
sum(VMs_other) as VMs_other,
sum(Foreign_VMs) as Foreign_VMs,
sum(Jobs) as Jobs,
sum(Jobs_s0) as Jobs_s0,
sum(Jobs_s1) as Jobs_s1,
sum(Jobs_s2) as Jobs_s2,
sum(Jobs_s3) as Jobs_s3,
sum(Jobs_s4) as Jobs_s4,
sum(Jobs_s5) as Jobs_s5,
sum(Jobs_s6) as Jobs_s6,
case when cores_ctl is null then 0 else case when cores_ctl=-1 or cores_ctl>cores_max then cores_max-cores_used else cores_ctl-cores_used end end as idle_cores,
case when ram_ctl is null then 0 else case when ram_ctl=-1 or ram_ctl>ram_max then ram_max-ram_used else ram_ctl-ram_used end end as idle_ram

from view_cloud_status_raw as vcsr

left outer join view_group_resources as vgr on
vcsr.group_name=vgr.group_name and
vcsr.cloud_name=vgr.cloud_name

group by group_name,cloud_name

;
