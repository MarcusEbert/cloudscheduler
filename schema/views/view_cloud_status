/*
** List all group resources (clouds) with VM & resource counts.
*/
create or replace view view_cloud_status as

select

css.group_name,
css.cloud_name,
enabled,
cascading_vm_flavor as default_flavor,
cascading_vm_image as default_image,
cascading_vm_keep_alive as keep_alive,
cascading_vm_keyname as default_keyname,
cascading_vm_network as default_network,
VMs,
VMs_starting,
VMs_unregistered,
VMs_idle,
VMs_running,
VMs_retiring,
VMs_manual,
VMs_in_error,
VMs_other,
Foreign_VMs,
sum(cores_ctl) as cores_ctl,
sum(cores_max) as cores_max,
sum(cores_native) as cores_busy,
sum(cores_foreign) as cores_foreign,
sum(cores_idle) as cores_idle,
sum(cores_idle)+sum(cores_native) as cores_native,
sum(ram_ctl) as ram_ctl,
sum(ram_max) as ram_max,
sum(ram_native) as ram_busy,
sum(ram_foreign) as ram_foreign,
sum(ram_idle) as ram_idle,
sum(ram_idle)+sum(ram_native) as ram_native,
slot_count,
slot_core_count,
slot_idle_core_count

from (
    select

    group_name,
    cloud_name,
    sum(VMs) as VMs,
    sum(VMs_starting) as VMs_starting,
    sum(VMs_unregistered) as VMs_unregistered,
    sum(VMs_idle) as VMs_idle,
    sum(VMs_running) as VMs_running,
    sum(VMs_retiring) as VMs_retiring,
    sum(VMs_manual) as VMs_manual,
    sum(VMs_in_error) as VMs_in_error,
    sum(VMs_other) as VMs_other,
    sum(Foreign_VMs) as Foreign_VMs,
    sum(slot_count) as slot_count,
    sum(slot_core_count) as slot_core_count,
    sum(slot_idle_core_count) as slot_idle_core_count

    from (
        /*
        ** Ensure all clouds are represented.
        */
        select

        group_name,
        cloud_name,
        0 as VMs,
        0 as VMs_starting,
        0 as VMs_unregistered,
        0 as VMs_idle,
        0 as VMs_running,
        0 as VMs_retiring,
        0 as VMs_manual,
        0 as VMs_in_error,
        0 as VMs_other,
        0 as Foreign_VMs,
        0 as slot_count,
        0 as slot_core_count,
        0 as slot_idle_core_count

        from view_group_resources

        /*
        ** Retrieve VM count for each group.
        */
        union all select

        group_name,
        cloud_name,
        case when foreign_vm=0 then 1 else 0 end as VMs,
        case when poller_status="starting" then 1 else 0 end as VMs_starting,
        case when poller_status="unregistered" then 1 else 0 end as VMs_unregistered,
        case when poller_status="idle" then 1 else 0 end as VMs_idle,
        case when poller_status="running" then 1 else 0 end as VMs_running,
        case when poller_status="retiring" then 1 else 0 end as VMs_retiring,
        case when poller_status="manual" then 1 else 0 end as VMs_manual,
        case when poller_status="error" then 1 else 0 end as VMs_in_error,
        case when poller_status="other" then 1 else 0 end as VMs_other,
        case when poller_status="foreign" then 1 else 0 end as Foreign_VMs,
        0 as slot_count,
        0 as slot_core_count,
        0 as slot_idle_core_count

        from view_vms

        /*
        ** Retrieve VM count for each group.
        */
        union all select

        group_name,
        cloud_name,
        0 as VMs,
        0 as VMs_starting,
        0 as VMs_unregistered,
        0 as VMs_idle,
        0 as VMs_running,
        0 as VMs_retiring,
        0 as VMs_manual,
        0 as VMs_in_error,
        0 as VMs_other,
        0 as Foreign_VMs,
        slot_count,
        slot_core_count,
        slot_idle_core_count
        from (

            select
            case when instr(machine,'--')=0 then
                "-"
            else
                substring_index(machine,'--',1)
            end as group_name,
            case when instr(machine,'--')=0 then
                "-"
            else
                substring_index(substring_index(machine,'--',2),'--',-1)
            end as cloud_name,

            case when state="Claimed" then
                1
            else
                0
            end as slot_count,

            case when state="Claimed" then
                slot_CPUs
            else
                0
            end as slot_core_count,

            case when state="Claimed" then
                0
            else
                slot_CPUs
            end as slot_idle_core_count

            from condor_machines
            ) as csc /* condor_slot_counts */
        ) as csr /* cloud_status_raw */
    group by group_name,cloud_name
    ) as css /* cloud_status_sum */

left outer join view_group_resources as vgr on
css.group_name=vgr.group_name and
css.cloud_name=vgr.cloud_name

group by group_name,cloud_name
;
