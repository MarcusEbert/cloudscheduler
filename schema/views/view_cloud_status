/*
** List all group resources (clouds) with VM & resource counts.
*/
create or replace view view_cloud_status as

select

grwvs.group_name,
grwvs.cloud_name,
cast(sum(VMs) as int) as VMs,
cast(sum(VMs_unregistered) as int) as VMs_unregistered,
cast(sum(VMs_running) as int) as VMs_running,
cast(sum(VMs_retiring) as int) as VMs_retiring,
cast(sum(VMs_manual) as int) as VMs_manual,
cast(sum(VMs_in_error) as int) as VMs_in_error,
cast(sum(VMs_other) as int) as VMs_other,
cast(sum(Foreign_VMs) as int) as Foreign_VMs,
cast(sum(condor_slots) as int) as "slots_max",
cast(sum(condor_slots_used) as int) as "slots_used",
cast(case when sum(condor_slots)=0 then 0 else round(sum(condor_slots_used) * 100 / sum(condor_slots), 2) end as double) as slots_percent,
case when cores_ctl is null then 0 else case when cores_ctl=-1 or cores_ctl>cores_max then cores_max else cores_ctl end end as cores_max,
cores_used,
cast(case when cores_ctl is null then 0 else case when cores_ctl=-1 then case when cores_max=0 then 0 else round(cores_used*100/cores_max, 2) end else case when cores_ctl=0 then 0 else round(cores_used*100/cores_ctl, 2) end end end as double) as cores_percent,
case when ram_ctl is null then 0 else case when ram_ctl=-1 or ram_ctl>ram_max then ram_max else ram_ctl end end as ram_max,
ram_used,
cast(case when ram_ctl is null then 0 else case when ram_ctl=-1 then case when ram_max=0 then 0 else round(ram_used*100/ram_max, 2) end else case when ram_ctl=0 then 0 else round(ram_used*100/ram_ctl, 2) end end end as double) as ram_percent

from (
    select

    group_name,
    cloud_name,
    0 as VMs,
    0 as VMs_unregistered,
    0 as VMs_running,
    0 as VMs_retiring,
    0 as VMs_manual,
    0 as VMs_in_error,
    0 as VMs_other,
    0 as Foreign_VMs,
    0 as condor_slots,
    0 as condor_slots_used

    from csv2_group_resources

    /*
    ** Retrieve VM count for each group.
    */
    union all select

    group_name,
    cloud_name,
    case when foreign_vm=0 then 1 else 0 end as VMs,
    case when poller_status="unregistered" then 1 else 0 end as VMs_unregistered,
    case when poller_status="running" then 1 else 0 end as VMs_running,
    case when poller_status="retiring" then 1 else 0 end as VMs_retiring,
    case when poller_status="manual" then 1 else 0 end as VMs_manual,
    case when poller_status="error" then 1 else 0 end as VMs_in_error,
    case when poller_status="other" then 1 else 0 end as VMs_other,
    case when poller_status="foreign" then 1 else 0 end as Foreign_VMs,
    condor_slots,
    condor_slots_used

    from view_vms
    ) as grwvs /* group_resources_with_vm_status */

left outer join view_group_resources as vgr on
grwvs.group_name=vgr.group_name and
grwvs.cloud_name=vgr.cloud_name

group by group_name,cloud_name

;
