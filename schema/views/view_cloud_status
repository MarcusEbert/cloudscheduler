/*
** List all group resources (clouds) with VM & resource counts.
*/
create or replace view view_cloud_status as

/* n01 - Apply group and cloud defaults */
select
    n02.*,
    ifnull(n05.Foreign_VMs,0) as Foreign_VMs,
    cc.enabled,
    cores_ctl,

    case when cores_ctl=-1 then
        case when cores_softmax=-1 then
            ifnull(cores_max,0)
        else
            least(cores_softmax, ifnull(cores_max,0))
        end
    else
        case when cores_softmax=-1 then
            least(cores_ctl, ifnull(cores_max,0))
        else
            least(cores_ctl, cores_softmax, ifnull(cores_max,0))
        end
    end as cores_limit,

    cl.cores_max as cores_quota,
    ifnull(n05.cores_foreign,0) as cores_foreign,
    ifnull(n02.cores_native,0)+ifnull(n05.cores_foreign,0) as cores_native_foreign,
    ram_ctl,

    case when ram_ctl=-1 then
        ifnull(ram_max,0)
    else
        least(ram_ctl, ifnull(ram_max,0))
    end as ram_limit,

    cl.ram_max as ram_quota,
    ifnull(n05.ram_foreign,0) as ram_foreign,
    ifnull(n02.ram_native,0)+ifnull(n05.ram_foreign,0) as ram_native_foreign

from (
    /* n02 - Retrieve all (native) VMs with condor slot information */
    select
        n03.group_name,
        n03.cloud_name,
        ifnull(sum(n03.VMs),0) as VMs,
        ifnull(sum(n03.VMs_manual),0) as VMs_manual,
        ifnull(sum(n03.VMs_in_error),0) as VMs_in_error,
        ifnull(sum(n03.VMs_starting),0) as VMs_starting,
        ifnull(sum(n03.VMs_retiring),0) as VMs_retiring,
        ifnull(sum(n03.VMs_unregistered),0) as VMs_unregistered,
        ifnull(sum(n03.VMs_idle),0) as VMs_idle,
        ifnull(sum(n03.VMs_running),0) as VMs_running,
        ifnull(sum(n03.cores_native),0) as cores_native,
        ifnull(sum(n03.ram_native),0) as ram_native,
        ifnull(sum(n03.slot_count),0) as slot_count,
        ifnull(sum(n03.slot_core_count),0) as slot_core_count,
        ifnull(sum(n03.slot_idle_core_count),0) as slot_idle_core_count
    from (
        /* n03 - Retrieve all (native) VMs with condor slot information */
        select
            group_name,
            cloud_name,
            0 as VMs,
            0 as cores_native,
            0 as ram_native,
            0 as VMs_manual,
            0 as VMs_in_error,
            0 as VMs_starting,
            0 as VMs_retiring,
            0 as VMs_unregistered,
            0 as VMs_idle,
            0 as VMs_running,
            0 as slot_count,
            0 as slot_core_count,
            0 as slot_idle_core_count
        from csv2_clouds as cc   
        union all select
            cv.group_name,
            cv.cloud_name,
            count(1) as VMs,
            sum(cf.cores) as cores_native,
            sum(cf.ram) as ram_native,
            sum(case when cv.manual_control=1 then 1 else 0 end) as VMs_manual,
            sum(case when cv.manual_control=0 and cv.status='ERROR' then 1 else 0 end) as VMs_in_error,
            sum(case when cv.manual_control=0 and cv.status='BUILD' then 1 else 0 end) as VMs_starting,
            sum(case when cv.manual_control=0 and cv.status='ACTIVE' and cv.retire>0 then 1 else 0 end) as VMs_retiring,
            sum(case when cv.manual_control=0 and cv.status='ACTIVE' and cv.retire<1 and ifnull(slot_count,0)<1 then 1 else 0 end) as VMs_unregistered,
            sum(case when cv.manual_control=0 and cv.status='ACTIVE' and cv.retire<1 and ifnull(slot_count,0)>0 and ifnull(slot_core_count,0)<1 then 1 else 0 end) as VMs_idle,
            sum(case when cv.manual_control=0 and cv.status='ACTIVE' and cv.retire<1 and ifnull(slot_count,0)>0 and ifnull(slot_core_count,0)>0 then 1 else 0 end) as VMs_running,
            sum(slot_count) as slot_count,
            sum(slot_core_count) as slot_core_count,
            sum(slot_idle_core_count) as slot_idle_core_count
        from csv2_vms as cv
        left outer join cloud_flavors as cf on
            cv.group_name=cf.group_name and
            cv.cloud_name=cf.cloud_name and
            cv.flavor_id=cf.id
        left outer join (
            /* n04 - Retrieve (native) condor slot information */
            select
                substring_index(machine, '--', 1) as group_name,
                substring_index(substring_index(machine, '--', 2), '--', -1) as cloud_name,
                substring_index(machine, '.', 1) as hostname,
                sum(case when slot_type='Partitionable' then 1 else 0 end) as slot_count,
                sum(case when slot_type='Dynamic' and state='Claimed' then slot_cpus else 0 end) as slot_core_count,
                sum(case when state!='Claimed' then slot_cpus else 0 end) as slot_idle_core_count
            from condor_machines as cm, (select config_value as csv2_host_id from csv2_configuration where category='SQL' and config_key='csv2_host_id') as cnf
            where machine like concat('%--', csv2_host_id, '--%')
            group by
                group_name,
                cloud_name,
                hostname
            ) as n04 on
            cv.group_name=n04.group_name and
            cv.cloud_name=n04.cloud_name and
            cv.hostname=n04.hostname
        group by
            group_name,
            cloud_name
        ) as n03 
    group by
        n03.group_name,
        n03.cloud_name
    ) as n02 
left outer join csv2_clouds as cc on
    n02.group_name=cc.group_name and
    n02.cloud_name=cc.cloud_name
left outer join cloud_limits as cl on
    n02.group_name=cl.group_name and
    n02.cloud_name=cl.cloud_name
left outer join (
    /* n05 - Get foreign VM counts */
    select
        cvf.group_name,
        cvf.cloud_name,
        sum(cvf.count) as Foreign_VMs,
        sum(cvf.count*cf.cores) as cores_foreign,
        sum(cvf.count*cf.ram) as ram_foreign
    from csv2_vms_foreign as cvf
    left outer join cloud_flavors as cf on
        cvf.group_name=cf.group_name and
        cvf.cloud_name=cf.cloud_name and
        cvf.flavor_id=cf.id
    group by
        cvf.group_name,
        cvf.cloud_name
    ) as n05 on
    n02.group_name=n05.group_name and
    n02.cloud_name=n05.cloud_name



