create or replace view view_condor_host as 
select
    cv.group_name,
    cloud_name,
    htcondor_fqdn,
    vmid,
    hostname,
    retire,
    case when slots=retiring_slots then 1 else 0 end as retiring,
    terminate,
    machine
from csv2_vms as cv
left outer join csv2_groups as cg on
    cv.group_name=cg.group_name
left outer join (
    select
        machine,
        condor_host,
        count(*) as slots,
        sum(case when activity='Retiring' then 1 else 0 end) as retiring_slots
    from condor_machines
    group by
        machine,
        condor_host
    ) as cm on
    cv.hostname=substring_index(cm.machine, '.', 1)
;
