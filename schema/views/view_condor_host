create or replace view view_condor_host as 
select
    cv.group_name,
    cloud_name,
    htcondor_fqdn,
    vmid,
    hostname,
    htcondor_partitionable_slots as primary_slots,
    htcondor_dynamic_slots as dynamic_slots,
    retire,
    case when slots-1=retiring_slots then 1 else 0 end as retiring,
    terminate,
    machine,
    updater
from csv2_vms as cv
left outer join csv2_groups as cg on
    cv.group_name=cg.group_name
left outer join (
    select
        machine,
        condor_host,
        count(*) as slots,
        sum(case when activity='Retiring' then 1 else 0 end) as retiring_slots
    from condor_machines
    group by
        machine,
        condor_host
    ) as cm on
    cv.hostname=cm.machine or 
    cv.hostname=substring_index(cm.machine, '.', 1) 
;
