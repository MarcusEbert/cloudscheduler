/*
** List all VMs together with foreign indicator, poller status, condor slot counts
** (used/total), condor_off, cores, disk, ram, and swap.
*/
create or replace view view_vms as

/*
** Retrieve information.
*/

select

cv.*,
cf.name as flavor_name,
cdp.condor_slots_used,
cpp.machine,
cpp.my_current_time,
cpp.entered_current_state,
cpp.state,
cpp.activity,
cpp.condor_slots,
cpp.condor_off,
cpp.idle_time,
cpp.retire_request_time,
cpp.retired_time,
case when concat(lower(cv.group_name),"--",lower(cv.cloud_name))=substring_index(cv.hostname, '--', 2) then False else True end as foreign_vm,
cores,
disk + ephemeral_disk as disk,
ram,
swap,
case when concat(lower(cv.group_name),"--",lower(cv.cloud_name))!=substring_index(cv.hostname, '--', 2) then
    'foreign'
else
    case when cv.manual_control = 1 then
        'manual'
    else
        case when cv.status = 'ERROR' then
            'error'
        else
            case when cv.power_status = 1 and cv.status = 'ACTIVE' and condor_slots is null then
                'unregistered'
            else
                case when cv.power_status = 1 and cv.status = 'ACTIVE' and (cpp.condor_off = 1 or cpp.condor_off = 2) then
                    'retiring'
                else
                    case when cv.power_status = 1 and cv.status = 'ACTIVE' and (cpp.condor_off is null or cpp.condor_off = 0) then
                        'running'
                    else
                        'other'
                    end
                end
            end
        end
    end
end as 'poller_status'

from csv2_vms as cv

left outer join cloud_flavors as cf on
    cv.group_name=cf.group_name and
    cv.cloud_name=cf.cloud_name and
    cv.flavor_id=cf.id

left outer join (
    select

    substring_index(machine,'.',1) as hostname,
    machine,
    my_current_time,
    entered_current_state,
    state,
    activity,
    total_slots as condor_slots,
    condor_off,
    idle_time,
    retire_request_time,
    retired_time

    from condor_machines

    where  slot_type="Partitionable"
    ) as cpp /* condor_primary_partition */

on cv.hostname=cpp.hostname

left outer join (
    select

    substring_index(machine,'.',1) as hostname,
    sum(case when activity="Busy" then 1 else 0 end) as condor_slots_used

    from condor_machines

    where  slot_type="Dynamic"

    group by machine
    ) as cdp /* condor_dynamic_partitions */

on cv.hostname=cdp.hostname

;
