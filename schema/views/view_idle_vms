create or replace view view_idle_vms as
select
    *
from (
    select
        cv.group_name,
        cv.cloud_name,
        case when ifnull(cc.vm_keep_alive,-1)>=120 then
            cc.vm_keep_alive
        else
            case when ifnull(cg.vm_keep_alive,-1)>=120 then
                cg.vm_keep_alive
            else
                120
            end
        end as keep_alive,
        vmid,
        hostname,
        htcondor_partitionable_slots as primary_slots,
        htcondor_dynamic_slots as dynamic_slots,
        retire,
        terminate,
        unix_timestamp()-ifnull(htcondor_slots_timestamp,unix_timestamp()) as age
    from csv2_vms as cv
    left outer join csv2_clouds as cc on
        cv.group_name=cc.group_name and
        cv.cloud_name=cc.cloud_name
    left outer join csv2_groups as cg on
        cc.group_name=cg.group_name
    ) as vms
where 
    age>keep_alive
;
