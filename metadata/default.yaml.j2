#cloud-config                                                                                                                                                       
merge_type: 'list(append)+dict(recurse_array)+str()'                                                                                                                
#### DO NOT EDIT - CHANGES WILL BE OVER_WRITTEN ####                                                                                                                

write_files:                                                                                                                                                        
-   content: |                                                                                                                                                      
        {{cs_cloud_type}}                                                                                                                                           
    owner: root:root                                                                                                                                                
    permissions: 0644
    path: /var/lib/cloud_type
-   content: |
        {{cs_condor_host}}
    owner: root:root
    permissions: 0644
    path: /etc/condor/central_manager
-   content: |                                                                                                                                                      
        {{cs_cloud_name}}                                                                                                                                           
    owner: root:root                                                                                                                                                
    permissions: 0644                                                                                                                                               
    path: /var/lib/cloud_name                                                                                                                                       
-   content: |                                                                                                                                                      
        # Local config for Cloud Scheduler

        ## Set this to the group_name using this VM                                                                                                                 
        cs_host_id = "{{cs_host_id}}"
        group_name = "{{cs_group_name}}"                                                                                                                            
        cloud_name = "{{cs_cloud_name}}"
        flavor = "{{cs_flavor}}"
        target_alias = "{{cs_cloud_alias}}"                                                                                                                         

        ## Hostname of the central manager.                                                                                                                         
        # Prefer value contextualized by Cloud Scheduler and then use central_manager
        CS_HOST={{cs_host}}                                                                                                                                         
        CS_HOST_IP={{cs_host_ip}}                                                                                                                                   
        CONDOR_HOST={{cs_condor_host}}                                                                                                                              
        CONDOR_HOST_IP={{cs_condor_host_ip}}                                                                                                                        
        STARTD_ATTRS = COLLECTOR_HOST_STRING cs_host_id group_name cloud_name flavor target_alias  
        ###### You should not need to make changes below here ########                                                                                              
        HOSTALLOW_WRITE = $(IP_ADDRESS), $(FULL_HOSTNAME), $(CONDOR_HOST_IP), $(CS_HOST_IP)
        ALLOW_WRITE = $(IP_ADDRESS), $(FULL_HOSTNAME), $(CONDOR_HOST_IP), $(CS_HOST_IP)                                                                             
        HOSTALLOW_ADMINISTRATOR = $(CONDOR_HOST_IP), $(CS_HOST_IP)
        ALLOW_ADMINISTRATOR = $(CONDOR_HOST_IP), $(CS_HOST_IP)                                                                                                      
        ALLOW_READ = *                                                                                                                                              
        HOSTALLOW_READ = *

        START = (Owner == "{{cs_user}}")
    owner: root:root                                                                                                                                                
    permissions: '0644'                                                                                                                                             
    path: /etc/condor/condor_config.local                                                                                                                           
-   content: |
        #!/bin/bash
        msg_post () 
        {
          while true; do
            curl https://{{cs_condor_host}}/$(hostname -s)${1} && break
            sleep 30
          done
        }   
            
        log_tail () 
        {
          touch $checkpoint_dir$1
          checkpoint=$(cat $checkpoint_dir$1)
          log_file_size=$(wc -l <$log_file_dir$1|tee $checkpoint_dir$1)
          [ "$checkpoint" != "" ] && [ $checkpoint -gt $log_file_size ] && checkpoint=0
          tail -n +$((checkpoint+1)) $log_file_dir$1
        }   
            
        which condor_config_val &>/dev/null||(msg_post "/STARTD/HTCondor_is_not_installed" && exit)

        log_file_dir=/var/log/condor/
        checkpoint_dir=/tmp/csv2htc.K.
        log_file_tail="$(log_tail MasterLog)$(log_tail StartLog)"
         
        error_msgs=$(echo "${log_file_tail}"|awk '/Error/{split($0,W,"Error");print W[2]}/ERROR/{split($0,W,"ERROR");print W[2]}'|tr ":" " "|awk 'NF>2{print "/"$1"_"$2"_"$3"_"$4"_"$5"&"}'|sort -u|tr -d '\n')
        if [ "$error_msgs" != "" ]; then msg_post "/STARTD${error_msgs}"; fi

        cert_file=$(condor_config_val gsi_daemon_cert 2>/dev/null)
        if [ $? -eq 0 ]; then 
          openssl x509 -in $cert_file -checkend -1 >/dev/null 2>&1
          if [ $? -eq 0 ]; then 
            openssl x509 -in $cert_file -checkend $(( 86400 * {{cs_condorworker_cert_days_to_end_of_life}} )) >/dev/null 2>&1
            if [ $? -ne 0 ]; then 
                msg_post "/CERT/expiring soon"
            else
              if [ 'True' == "{{cs_condorworker_optional_gsi_messages}}" ]; then
                msg_post "/GSIok"
              fi
            fi
          else
            which systemctl && systemctl stop condor || service stop condor
            msg_post "/CERT/EXPIRED"
          fi
        else
          if [ 'True' == "{{cs_condorworker_optional_gsi_messages}}" ]; then
            msg_post "/GSInone"
          fi
        fi

        if [ -e /usr/local/sbin/apel_accounting.sh ]; then
            IFS=$'\n' lines=($(/usr/local/sbin/apel_accounting.sh))
            size=${#lines[@]}
            (( size -= 1 ))
            for ix in $(seq 0 $size); do
                msg_post "/${lines[$ix]}"
            done
        fi
    owner: root:root
    permissions: 0700
    path: /usr/local/sbin/csv2_vm_data
-   content: |
        */5 * * * * root /usr/local/sbin/csv2_vm_data
    owner: root:root
    permissions: 0600
    path: /etc/cron.d/csv2_vm_data
runcmd:                                                                                                                                                             
 - [ service, condor, restart ]              

