#cloud-config                                                                                                                                                       
merge_type: 'list(append)+dict(recurse_array)+str()'                                                                                                                
#### DO NOT EDIT - CHANGES WILL BE OVER_WRITTEN ####                                                                                                                

write_files:                                                                                                                                                        
-   content: |                                                                                                                                                      
        {{cs_cloud_type}}                                                                                                                                           
    owner: root:root                                                                                                                                                
    permissions: 0644
    path: /var/lib/cloud_type
-   content: |
        {{cs_condor_host}}
    owner: root:root
    permissions: 0644
    path: /etc/condor/central_manager
-   content: |                                                                                                                                                      
        {{cs_cloud_name}}                                                                                                                                           
    owner: root:root                                                                                                                                                
    permissions: 0644                                                                                                                                               
    path: /var/lib/cloud_name                                                                                                                                       
-   content: |                                                                                                                                                      
        # Local config for Cloud Scheduler

        ## Set this to the group_name using this VM                                                                                                                 
        cs_host_id = "{{cs_host_id}}"
        group_name = "{{cs_group_name}}"                                                                                                                            
        cloud_name = "{{cs_cloud_name}}"
        flavor = "{{cs_flavor}}"
        target_alias = "{{cs_cloud_alias}}"                                                                                                                         

        ## Hostname of the central manager.                                                                                                                         
        # Prefer value contextualized by Cloud Scheduler and then use central_manager
        CS_HOST={{cs_host}}                                                                                                                                         
        CS_HOST_IP={{cs_host_ip}}                                                                                                                                   
        CONDOR_HOST={{cs_condor_host}}                                                                                                                              
        CONDOR_HOST_IP={{cs_condor_host_ip}}                                                                                                                        
        STARTD_ATTRS = COLLECTOR_HOST_STRING cs_host_id group_name cloud_name flavor target_alias  
        ###### You should not need to make changes below here ########                                                                                              
        HOSTALLOW_WRITE = $(IP_ADDRESS), $(FULL_HOSTNAME), $(CONDOR_HOST_IP), $(CS_HOST_IP)
        ALLOW_WRITE = $(IP_ADDRESS), $(FULL_HOSTNAME), $(CONDOR_HOST_IP), $(CS_HOST_IP)                                                                             
        HOSTALLOW_ADMINISTRATOR = $(CONDOR_HOST_IP), $(CS_HOST_IP)
        ALLOW_ADMINISTRATOR = $(CONDOR_HOST_IP), $(CS_HOST_IP)                                                                                                      
        ALLOW_READ = *                                                                                                                                              
        HOSTALLOW_READ = *

        START = (Owner == "{{cs_user}}")
    owner: root:root                                                                                                                                                
    permissions: '0644'                                                                                                                                             
    path: /etc/condor/condor_config.local                                                                                                                           
-   content: |
        #!/bin/bash
        P () 
        {
          while true; do
            curl https://{{cs_condor_host}}/$(hostname -s)${1} && break
            sleep 30
          done
        }   
            
        T () 
        {
          touch $K$1
          S=$(cat $K$1)
          C=$(wc -l <$I$1|tee $K$1)
          [ "$S" != "" ] && [ $S -gt $C ] && S=0
          tail -n +$((S+1)) $I$1
        }   
            
        which condor_config_val &>/dev/null||(P "/STARTD/HTCondor_is_not_installed" && exit)

        I=/var/log/condor/
        K=/tmp/csv2htc.K.
        O="$(T MasterLog)$(T StartLog)"
         
        M=$(echo "${O}"|awk '/Error/{split($0,W,"Error");print W[2]}/ERROR/{split($0,W,"ERROR");print W[2]}'|tr ":" " "|awk 'NF>2{print "/"$1"_"$2"_"$3"_"$4"_"$5"&"}'|sort -u|tr -d '\n')
        if [ "$M" != "" ];then P "/STARTD${M}"

        cert_file=$(condor_config_val gsi_daemon_cert 2>/dev/null)
        if [ $? -eq 0 ]; then 
          openssl x509 -in $cert_file -checkend -1 >/dev/null 2>&1
          if [ $? -eq 0 ]; then 
            openssl x509 -in $cert_file -checkend $(( 86400 * {{cert_days_to_end_of_life}} )) >/dev/null 2>&1
            if [ $? -ne 0 ]; then 
                P "/CERT/expiring soon" && exit)
            fi
          else
            which systemctl && systemctl stop condor || service stop condor
            P "/CERT/EXPIRED" && exit)
          fi
        fi
    owner: root:root
    permissions: 0700
    path: /root/csv2HTC
-   content: |
        */5 * * * * root /root/csv2HTC
    owner: root:root
    permissions: 0600
    path: /etc/cron.d/csv2HTC
runcmd:                                                                                                                                                             
 - [ service, condor, restart ]              

